from forge.sdk import (
    Agent,
    AgentDB,
    ForgeLogger,
    Step,
    StepRequestBody,
    Task,
    TaskRequestBody,
    Workspace,    
    PromptEngine,	
    chat_completion_request,	
    ChromaMemStore	
)
import json	
import pprint

LOG = ForgeLogger(__name__)

class ForgeAgent(Agent):
    """
    Forge çš„ç›®æ ‡æ˜¯å¤„ç†æ ·æ¿ä»£ç ï¼Œè®©æ‚¨å¯ä»¥ä¸“æ³¨äºä»£ç†è®¾è®¡ã€‚

    æœ‰ä¸€ç¯‡å¯¹ä»£ç†é£æ™¯è¿›è¡Œäº†å¾ˆå¥½çš„è°ƒæŸ¥è®ºæ–‡ï¼šhttps://arxiv.org/abs/2308.11432
    æˆ‘å¼ºçƒˆå»ºè®®é˜…è¯»å®ƒï¼Œå› ä¸ºå®ƒå°†å¸®åŠ©æ‚¨ç†è§£å¯èƒ½æ€§ã€‚

    è¿™æ˜¯ä»£ç†çš„å…³é”®ç»„æˆéƒ¨åˆ†çš„æ‘˜è¦ï¼š

    ä»£ç†çš„æ„é€ ï¼š
         - ä¸ªäººèµ„æ–™
         - å†…å­˜
         - è§„åˆ’
         - åŠ¨ä½œ

    ä¸ªäººèµ„æ–™ï¼š

    ä»£ç†é€šå¸¸é€šè¿‡æ‰®æ¼”ç‰¹å®šè§’è‰²æ¥æ‰§è¡Œä»»åŠ¡ã€‚ä¾‹å¦‚ï¼Œæ•™å¸ˆã€ç¼–ç å‘˜ã€è§„åˆ’å‘˜ç­‰ã€‚åœ¨ä½¿ç”¨ä¸ªäººèµ„æ–™åœ¨ llm æç¤ºä¸­å·²ç»æ˜¾ç¤ºå‡ºå®ƒå¯ä»¥æé«˜è¾“å‡ºçš„è´¨é‡ã€‚

    æ­¤å¤–ï¼Œæ ¹æ®æ‰€é€‰æ‹©çš„ä¸ªäººèµ„æ–™ï¼Œä»£ç†å¯ä»¥é…ç½®ä¸ºä½¿ç”¨ä¸åŒçš„ llmã€‚å¯èƒ½æ€§æ— ç©·æ— å°½ï¼Œå¯ä»¥æ ¹æ®æ‰‹å¤´çš„ä»»åŠ¡åŠ¨æ€é€‰æ‹©ä¸ªäººèµ„æ–™ã€‚

    å†…å­˜ï¼š

    å†…å­˜å¯¹äºä»£ç†ç§¯ç´¯ç»éªŒã€è‡ªæˆ‘æ¼”åŒ–ä»¥åŠä»¥æ›´ä¸€è‡´ã€åˆç†å’Œæœ‰æ•ˆçš„æ–¹å¼è¡Œä¸ºè‡³å…³é‡è¦ã€‚å†…å­˜æœ‰è®¸å¤šæ–¹æ³•ã€‚ä½†æ˜¯ï¼Œæœ‰ä¸€äº›æƒ³æ³•ï¼šé•¿æœŸå’ŒçŸ­æœŸæˆ–å·¥ä½œè®°å¿†ã€‚æ‚¨å¯èƒ½éœ€è¦ä¸ºæ¯ä¸ªé‡‡å–ä¸åŒçš„æ–¹æ³•ã€‚è¿˜æœ‰å…³äºå†…å­˜åæ€çš„ç ”ç©¶ï¼Œå³è¯„ä¼°å…¶è®°å¿†å¹¶é‡æ–°è¯„ä¼°å…¶è®°å¿†çš„èƒ½åŠ›ã€‚ä¾‹å¦‚ï¼Œå°†çŸ­æœŸè®°å¿†å‹ç¼©æˆé•¿æœŸè®°å¿†ã€‚

    è§„åˆ’ï¼š

    å½“äººç±»é¢ä¸´å¤æ‚ä»»åŠ¡æ—¶ï¼Œä»–ä»¬é¦–å…ˆå°†å…¶åˆ†è§£ä¸ºç®€å•çš„å­ä»»åŠ¡ï¼Œç„¶åé€ä¸ªè§£å†³æ¯ä¸ªå­ä»»åŠ¡ã€‚è§„åˆ’æ¨¡å—èµ‹äºˆåŸºäº LLM çš„ä»£ç†æ€è€ƒå’Œè®¡åˆ’è§£å†³å¤æ‚ä»»åŠ¡çš„èƒ½åŠ›ï¼Œä»è€Œä½¿ä»£ç†æ›´å…¨é¢ã€å¼ºå¤§å’Œå¯é ã€‚éœ€è¦è€ƒè™‘çš„ä¸¤ç§å…³é”®æ–¹æ³•æ˜¯ï¼šå¸¦åé¦ˆçš„è§„åˆ’å’Œä¸å¸¦åé¦ˆçš„è§„åˆ’ã€‚

    åŠ¨ä½œï¼š

    åŠ¨ä½œå°†ä»£ç†çš„å†³ç­–è½¬åŒ–ä¸ºå…·ä½“çš„ç»“æœã€‚ä¾‹å¦‚ï¼Œå¦‚æœä»£ç†å†³å®šå†™ä¸€ä¸ªæ–‡ä»¶ï¼ŒåŠ¨ä½œå°±æ˜¯å†™æ–‡ä»¶ã€‚æ‚¨å¯ä»¥å®æ–½è®¸å¤šæ–¹æ³•æ¥æ‰§è¡ŒåŠ¨ä½œã€‚

    Forge æ¯ä¸ªé¢†åŸŸéƒ½æœ‰ä¸€ä¸ªåŸºæœ¬æ¨¡å—ã€‚ä½†æ˜¯ï¼Œæ‚¨å¯ä»¥è‡ªå·±å®ç°ã€‚è¿™åªæ˜¯ä¸€ä¸ªèµ·ç‚¹ã€‚
    """

    def __init__(self, database: AgentDB, workspace: Workspace):
        """
        æ•°æ®åº“ç”¨äºå­˜å‚¨ä»»åŠ¡ã€æ­¥éª¤å’Œå·¥ä»¶å…ƒæ•°æ®ã€‚å·¥ä½œåŒºç”¨äºå­˜å‚¨å·¥ä»¶ã€‚å·¥ä½œåŒºæ˜¯æ–‡ä»¶ç³»ç»Ÿä¸Šçš„ç›®å½•ã€‚

        è¯·éšæ—¶åˆ›å»ºæ•°æ®åº“å’Œå·¥ä½œåŒºçš„å­ç±»ï¼Œä»¥å®ç°æ‚¨è‡ªå·±çš„å­˜å‚¨
        """
        super().__init__(database, workspace)

    async def create_task(self, task_request: TaskRequestBody) -> Task:
        """
        Forge çš„æ ¸å¿ƒæ˜¯ä»£ç†åè®®ï¼Œå®ƒé€šè¿‡åˆ›å»ºä»»åŠ¡ï¼Œç„¶åä¸ºè¯¥ä»»åŠ¡æ‰§è¡Œæ­¥éª¤æ¥å·¥ä½œã€‚å½“ä»£ç†è¢«è¦æ±‚åˆ›å»ºä»»åŠ¡æ—¶ï¼Œä¼šè°ƒç”¨æ­¤æ–¹æ³•ã€‚

        æˆ‘ä»¬æ­£åœ¨é€šè¿‡æ­¤å‡½æ•°æ¥æ·»åŠ è‡ªå®šä¹‰æ—¥å¿—æ¶ˆæ¯ã€‚å°½ç®¡æ‚¨å¯ä»¥åœ¨æ­¤å¤„æ‰§è¡Œä»»ä½•æ‚¨æƒ³è¦çš„æ“ä½œã€‚
        """
        task = await super().create_task(task_request)
        LOG.info(
            f"ğŸ“¦ Task created: {task.task_id} input: {task.input[:40]}{'...' if len(task.input) > 40 else ''}"
        )
        return task
    
    async def execute_step(self, task_id: str, step_request: StepRequestBody) -> Step:
        """
        è¦äº†è§£å¦‚ä½•æ·»åŠ è‡ªå·±çš„é€»è¾‘ï¼Œè¯·å‚é˜…å®˜æ–¹æ•™ç¨‹ç³»åˆ—ï¼š
        https://aiedge.medium.com/autogpt-forge-e3de53cc58ec

        Forge çš„æ ¸å¿ƒæ˜¯ä»£ç†åè®®ï¼Œå®ƒé€šè¿‡åˆ›å»ºä»»åŠ¡ï¼Œç„¶åä¸ºè¯¥ä»»åŠ¡æ‰§è¡Œæ­¥éª¤æ¥å·¥ä½œã€‚å½“ä»£ç†è¢«è¦æ±‚æ‰§è¡Œæ­¥éª¤æ—¶ï¼Œå°†è°ƒç”¨æ­¤æ–¹æ³•ã€‚

        åˆ›å»ºçš„ä»»åŠ¡åŒ…å«ä¸€ä¸ªè¾“å…¥å­—ç¬¦ä¸²ï¼Œå¯¹äºåŸºå‡†æµ‹è¯•ï¼Œè¿™æ˜¯ä»£ç†è¢«è¦æ±‚è§£å†³çš„ä»»åŠ¡ï¼Œè¿˜åŒ…å«é™„åŠ è¾“å…¥ï¼Œå®ƒæ˜¯ä¸€ä¸ªå­—å…¸ï¼Œå¯ä»¥åŒ…å«ä»»ä½•å†…å®¹ã€‚

        å¦‚æœæ‚¨æƒ³è·å–ä»»åŠ¡ï¼Œè¯·ä½¿ç”¨ï¼š

        ```
        task = await self.db.get_task(task_id)
        ```

        æ­¥éª¤è¯·æ±‚æ­£æ–‡åŸºæœ¬ä¸Šä¸ä»»åŠ¡è¯·æ±‚ç›¸åŒï¼ŒåŒ…å«ä¸€ä¸ªè¾“å…¥å­—ç¬¦ä¸²ï¼Œå¯¹äºåŸºå‡†æµ‹è¯•ï¼Œè¿™æ˜¯ä»£ç†è¢«è¦æ±‚è§£å†³çš„ä»»åŠ¡ï¼Œè¿˜åŒ…å«é™„åŠ è¾“å…¥ï¼Œå®ƒæ˜¯ä¸€ä¸ªå­—å…¸ï¼Œå¯ä»¥åŒ…å«ä»»ä½•å†…å®¹ã€‚

        æ‚¨éœ€è¦å®ç°ä¸€ä¸ªé€»è¾‘ï¼Œå°†æ¥å—æ­¤æ­¥éª¤è¾“å…¥å¹¶è¾“å‡ºå·²å®Œæˆçš„æ­¥éª¤ä½œä¸ºæ­¥éª¤å¯¹è±¡ã€‚æ‚¨å¯ä»¥åœ¨ä¸€ä¸ªæ­¥éª¤ä¸­æ‰§è¡Œæ‰€æœ‰æ“ä½œï¼Œä¹Ÿå¯ä»¥å°†å…¶åˆ†è§£ä¸ºå¤šä¸ªæ­¥éª¤ã€‚é€šè¿‡åœ¨æ­¥éª¤è¾“å‡ºä¸­è¿”å›ç»§ç»­è¯·æ±‚ï¼Œç”¨æˆ·å¯ä»¥å†³å®šæ˜¯å¦å¸Œæœ›ä»£ç†ç»§ç»­æ‰§è¡Œæˆ–åœæ­¢ã€‚
        """
        # ä¸‹é¢æ˜¯ä¸€ä¸ªç¤ºä¾‹

        step = await self.db.create_step(
            task_id=task_id, input=step_request, is_last=True
        )

        self.workspace.write(task_id=task_id, path="output.txt", data=b"Washington D.C")

        await self.db.create_artifact(
            task_id=task_id,
            step_id=step.step_id,
            file_name="output.txt",
            relative_path="",
            agent_created=True,
        )

        step.output = "Washington D.C"

        LOG.info(f"\tâœ… Final Step completed: {step.step_id}. \n" +
                 f"Output should be placeholder text Washington D.C. You'll need to \n" +
                 f"modify execute_step to include LLM behavior. Follow the tutorial " +
                 f"if confused. ")

        return step
